#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะดะตะฟะปะพั ะฟัะธะปะพะถะตะฝะธั Employees (ะฑะตะท Docker)

echo "๐ ะะฐัะธะฝะฐะตะผ ะดะตะฟะปะพะน ะฟัะธะปะพะถะตะฝะธั Employees..."

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต Node.js
if ! command -v node &> /dev/null; then
    echo "โ Node.js ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะะพะถะฐะปัะนััะฐ, ัััะฐะฝะพะฒะธัะต Node.js 18+."
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฒะตััะธั Node.js
NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 18 ]; then
    echo "โ ะขัะตะฑัะตััั Node.js ะฒะตััะธะธ 18 ะธะปะธ ะฒััะต. ะขะตะบััะฐั ะฒะตััะธั: $(node -v)"
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต npm
if ! command -v npm &> /dev/null; then
    echo "โ npm ะฝะต ัััะฐะฝะพะฒะปะตะฝ."
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต PM2
if ! command -v pm2 &> /dev/null; then
    echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ PM2..."
    npm install -g pm2
fi

# ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธั ะดะปั ะปะพะณะพะฒ
mkdir -p logs

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ
echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ..."
npm install

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ ะบะปะธะตะฝัะฐ
echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ ะบะปะธะตะฝัะฐ..."
cd client
npm install
cd ..

# ะกะพะทะดะฐะตะผ production build
echo "๐จ ะกะพะทะดะฐะตะผ production build..."
cd client
npm run build
cd ..

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะน ะฟัะพัะตัั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัััะตััะฒัััะธะน ะฟัะพัะตัั..."
pm2 stop employees-app 2>/dev/null || true
pm2 delete employees-app 2>/dev/null || true

# ะะฐะฟััะบะฐะตะผ ะฟัะธะปะพะถะตะฝะธะต
echo "๐ ะะฐะฟััะบะฐะตะผ ะฟัะธะปะพะถะตะฝะธะต..."
pm2 start ecosystem.config.js

# ะะดะตะผ ะทะฐะฟััะบะฐ
echo "โณ ะะดะตะผ ะทะฐะฟััะบะฐ ะฟัะธะปะพะถะตะฝะธั..."
sleep 5

# ะัะพะฒะตััะตะผ ััะฐััั
echo "๐ ะัะพะฒะตััะตะผ ััะฐััั ะฟัะธะปะพะถะตะฝะธั..."
pm2 status

# ะัะพะฒะตััะตะผ ะปะพะณะธ
echo "๐ ะะพัะปะตะดะฝะธะต ะปะพะณะธ:"
pm2 logs employees-app --lines 10

echo "โ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ!"
echo "๐ ะัะธะปะพะถะตะฝะธะต ะดะพัััะฟะฝะพ ะฟะพ ะฐะดัะตัั: http://localhost:8000"
echo "๐ ะะปั ะฟัะพัะผะพััะฐ ะปะพะณะพะฒ: pm2 logs employees-app"
echo "๐ ะะปั ะพััะฐะฝะพะฒะบะธ: pm2 stop employees-app"
echo "๐ ะะปั ะฟะตัะตะทะฐะฟััะบะฐ: pm2 restart employees-app"
